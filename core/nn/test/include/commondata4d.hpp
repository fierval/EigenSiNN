#pragma once

#include <unsupported/Eigen/CXX11/Tensor>
#include <device/device_tensor.hpp>

using namespace Eigen;
using namespace EigenSinn;

namespace EigenSinnTest {

  template <typename Device_>
  struct CommonData4d {

    // data will be presented in NHWC format
    CommonData4d() {

    }

    void init() {
      convLoss.resize(convOutDims);
      batchNormLoss.resize(dims);
      convInput.resize(dims);
      dinput.resize(dims);

      convInput.setValues({ {{{0.04538226, 0.95949411, 0.50452268, 0.59602135},
        {0.74790466, 0.73222357, 0.07335120, 0.85607505},
        {0.90876633, 0.47080678, 0.24576986, 0.59051216},
        {0.29745585, 0.98773926, 0.62964255, 0.36631453}},

        {{0.50406832, 0.42415136, 0.34337270, 0.72482306},
        {0.46068907, 0.96129739, 0.62765759, 0.27029365},
        {0.35458261, 0.38653296, 0.47089547, 0.82289129},
        {0.63725311, 0.29671627, 0.54370487, 0.87211448}},

        {{0.85018283, 0.75999165, 0.15591985, 0.40320259},
        {0.74964321, 0.10842186, 0.55331987, 0.58271384},
        {0.67342269, 0.74921608, 0.96604007, 0.26602185},
        {0.53013945, 0.98281318, 0.43664277, 0.76730776}} },


        {{{0.61419797, 0.84584051, 0.52509171, 0.18094194},
        {0.38709599, 0.25413889, 0.74516875, 0.27006137},
        {0.72085720, 0.84589291, 0.62312174, 0.93618810},
        {0.64560336, 0.61316019, 0.96158671, 0.92482752}},

        {{0.11359078, 0.84837216, 0.81256318, 0.98481309},
        {0.36437154, 0.10838908, 0.87681556, 0.37505645},
        {0.05423701, 0.66477776, 0.46080470, 0.09901488},
        {0.24049366, 0.78823119, 0.09643930, 0.77357787}},

        {{0.92674822, 0.49461865, 0.82311010, 0.50724411},
        {0.43091267, 0.64998370, 0.53645664, 0.69436163},
        {0.01849866, 0.22924691, 0.96253598, 0.99673647},
        {0.09387362, 0.86051500, 0.52929527, 0.41473496}}} });

      batchNormLoss.setValues({ {{{0.03411579, 0.30640966, 0.19440770, 0.00902396},
          {0.87998140, 0.08524799, 0.20483696, 0.11298430},
          {0.33172631, 0.01118428, 0.81524986, 0.33781791},
          {0.72575861, 0.48591703, 0.83571565, 0.74452734}},

         {{0.99675554, 0.52758676, 0.70237589, 0.33300936},
          {0.18728876, 0.86973250, 0.55728424, 0.77503520},
          {0.90626729, 0.46376646, 0.63194448, 0.14518911},
          {0.89655298, 0.54174763, 0.61954391, 0.52469307}},

         {{0.73198414, 0.08069026, 0.49224281, 0.47842449},
          {0.98264766, 0.13089573, 0.07510883, 0.34220546},
          {0.08220178, 0.48254997, 0.63483059, 0.02323723},
          {0.77521580, 0.24670333, 0.50362766, 0.62766153}}},


        {{{0.98965490, 0.88055056, 0.92259568, 0.24774176},
          {0.72176152, 0.90675122, 0.08763289, 0.57801038},
          {0.17916220, 0.27972364, 0.25751638, 0.81748664},
          {0.56826556, 0.73269165, 0.31478405, 0.95569855}},

         {{0.51677078, 0.98813075, 0.33273274, 0.64959395},
          {0.08583117, 0.13452137, 0.38807088, 0.40816027},
          {0.35822779, 0.15018040, 0.96034634, 0.90043443},
          {0.91827869, 0.20131719, 0.65043378, 0.43243688}},

         {{0.91697454, 0.39756697, 0.30185652, 0.28277457},
          {0.81693399, 0.69717938, 0.09399003, 0.18187153},
          {0.63124579, 0.38466102, 0.76345491, 0.11254698},
          {0.19470620, 0.97134984, 0.39794821, 0.64935327}}} });

    convLoss.setValues({ {{{0.52655923, 0.91497749},
      {0.55097681, 0.55695909}},

     {{0.38170123, 0.22313505},
      {0.90244251, 0.75970703}},

     {{0.94758117, 0.15442288},
      {0.83576518, 0.88915426}},

     {{0.50519013, 0.57455820},
      {0.56564820, 0.66149050}},

     {{0.40158027, 0.45649415},
      {0.78431153, 0.30682415}}},


    {{{0.11868435, 0.16316265},
      {0.94931650, 0.50302845}},

     {{0.92081302, 0.45813042},
      {0.27644420, 0.37698764}},

     {{0.53511274, 0.45706326},
      {0.88924468, 0.55211645}},

     {{0.00830925, 0.53979075},
      {0.05123097, 0.76055157}},

     {{0.84883726, 0.50166541},
      {0.81442124, 0.09462160}}} });


    convWeights.resize(kernelDims);
    convWeights.setValues({ {{{0.73027867, 0.38850695, 0.77408355},
        {0.49297833, 0.90659672, 0.18836355},
        {0.04310435, 0.30909634, 0.00293785}},

        {{0.49081051, 0.87883854, 0.22793245},
        {0.19394869, 0.74816018, 0.78440493},
        {0.45378476, 0.95257068, 0.22738194}},

        {{0.41356409, 0.45724821, 0.24288720},
        {0.83653516, 0.42836541, 0.36886293},
        {0.98561019, 0.88817686, 0.48391497}}},


      {{{0.86350316, 0.96448332, 0.06198353},
        {0.95530832, 0.95722210, 0.75767708},
        {0.14234066, 0.24686331, 0.48784947}},

        {{0.07517987, 0.48688841, 0.18591839},
        {0.24511278, 0.50047857, 0.09139228},
        {0.97555739, 0.19958436, 0.97825253}},

        {{0.90035379, 0.78639597, 0.68752265},
        {0.52299327, 0.17531115, 0.21360350},
        {0.84026957, 0.55812812, 0.37416142}}},


      {{{0.02347732, 0.84262252, 0.65620863},
        {0.21216887, 0.40895957, 0.93928844},
        {0.11966574, 0.04948360, 0.27720475}},

        {{0.25084192, 0.57170177, 0.65008521},
        {0.52581978, 0.43699783, 0.65302229},
        {0.08914214, 0.60709846, 0.93634570}},

        {{0.67080891, 0.67866302, 0.48880851},
        {0.01020145, 0.80715001, 0.14512080},
        {0.92411852, 0.26756018, 0.30676693}}},


      {{{0.17910123, 0.34714842, 0.34882456},
        {0.33346462, 0.75892407, 0.95541811},
        {0.68276197, 0.25997961, 0.89379877}},

        {{0.90402716, 0.27238405, 0.78153652},
        {0.78123343, 0.53185731, 0.43548268},
        {0.40001965, 0.12694675, 0.58085465}},

        {{0.31509912, 0.89059222, 0.69820553},
        {0.11363745, 0.39980549, 0.98195344},
        {0.80481243, 0.03052139, 0.64525765}}},


      {{{0.85137045, 0.98315364, 0.27414405},
        {0.55130732, 0.12552744, 0.74503434},
        {0.02404851, 0.14670181, 0.27567273}},

        {{0.00645614, 0.91220778, 0.31516474},
        {0.59764630, 0.41346133, 0.03927219},
        {0.19605428, 0.46631879, 0.30185586}},

        {{0.20861250, 0.46367437, 0.20343071},
        {0.07243395, 0.84193242, 0.05789715},
        {0.08896810, 0.86906624, 0.00832963}}} });

    dweight.resize(kernelDims);
    dweight.setValues({ {{{2.42792964, 2.21331191, 2.26331353},
        {3.02395153, 2.11717510, 2.48119044},
        {2.76820993, 2.63554096, 2.82542872}},

        {{1.99507403, 2.19397831, 2.61853313},
        {1.97961581, 2.57452297, 1.94809699},
        {1.79645956, 2.05157375, 2.33771110}},

        {{2.54319596, 1.99065566, 2.11944103},
        {1.57233262, 2.38069463, 3.09705591},
        {2.44117355, 3.33052063, 2.40798068}}},


      {{{2.61852002, 2.56592798, 1.91634536},
        {2.61768532, 1.95159721, 2.22450209},
        {2.93169117, 3.20066023, 2.68923092}},

        {{2.06794691, 3.09683323, 2.64774179},
        {1.65476787, 2.07254076, 2.49392414},
        {1.74022901, 2.01094222, 2.30453730}},

        {{2.69709611, 2.05755115, 2.49189520},
        {2.27334690, 2.84540033, 2.86905050},
        {2.12170625, 2.80966997, 3.05069304}}},


      {{{2.66710854, 2.99432755, 2.56803036},
        {3.43125486, 2.89000320, 2.52534294},
        {3.74569035, 3.68305898, 3.30305505}},

        {{2.61531639, 3.22230196, 3.07392311},
        {1.88480711, 3.05391002, 2.86678696},
        {2.17402720, 2.49093509, 2.60784054}},

        {{3.10994720, 2.84190464, 2.72328734},
        {2.62677383, 3.00160885, 3.66889358},
        {2.74402380, 3.68881941, 3.67395878}}},


      {{{2.15641928, 2.10753369, 1.55071056},
        {2.44468927, 1.76254106, 1.95446956},
        {2.51325083, 2.46040463, 2.32507920}},

        {{1.95481682, 2.48859024, 1.99226630},
        {1.81122530, 2.23511887, 1.59173286},
        {1.92905617, 1.36131299, 2.24569464}},

        {{2.15303111, 1.79058909, 1.84510267},
        {1.84726429, 2.47428513, 2.52339315},
        {2.50384307, 2.74641848, 2.28400278}}},


      {{{2.55247140, 2.47130919, 1.96380591},
        {2.61500549, 2.10962009, 2.15826774},
        {2.73628044, 2.89012575, 2.84371901}},

        {{1.88134646, 2.57262039, 2.97734737},
        {1.49127245, 2.23708844, 2.31433868},
        {1.55966938, 2.21626019, 1.85132706}},

        {{2.75680685, 2.04408002, 2.31519651},
        {1.83719313, 2.27878308, 3.00943017},
        {1.61837482, 3.07503510, 2.87464929}}} });


    dinput.setValues({ {{{1.16875565, 3.29740238, 2.68845081, 1.14899850},
        {3.18542695, 7.02379704, 7.33272886, 2.75205851},
        {2.47707772, 4.79866600, 6.40820742, 3.17002392},
        {0.65728080, 1.39412355, 2.01602387, 1.29455924}},

        {{0.98412848, 2.72122550, 2.90234327, 0.94333512},
        {2.39295721, 5.89328384, 6.01423120, 2.56698251},
        {2.65477037, 5.68656683, 6.09244967, 2.42952299},
        {1.58494925, 3.04779768, 3.80499697, 2.17922997}},

        {{1.44003761, 2.77930951, 2.70993590, 0.94515461},
        {2.67914867, 6.75891781, 6.00656891, 2.61468673},
        {3.22020078, 5.95870876, 5.14079142, 2.11224198},
        {2.59870887, 4.48420429, 2.67562628, 1.25592458}}},


      {{{1.61852372, 3.27180076, 2.30667686, 0.78044778},
        {3.17784739, 5.51820087, 6.06698084, 2.76294279},
        {1.61313832, 3.58580637, 4.75043106, 2.66756272},
        {0.24124521, 1.20143735, 1.14193738, 1.04430497}},

        {{0.27469882, 2.35554075, 2.05254388, 0.99946845},
        {1.80524004, 5.58070850, 3.98657990, 1.89098716},
        {2.41582656, 4.62675333, 5.17150593, 2.50270629},
        {0.95990586, 2.85365081, 2.62479925, 1.47047257}},

        {{1.41679573, 2.60383821, 2.56036830, 1.05696058},
        {2.07280540, 4.69602966, 4.21187735, 1.98498297},
        {2.48002219, 5.54359770, 3.30058622, 1.84156883},
        {2.10339999, 3.88803029, 1.78581071, 1.04538822}}} });

    output.resize(convOutDims);
    output.setValues({ {{{8.07499599, 7.15045643},
        {8.10665131, 8.34483147}},

        {{8.02071381, 8.00105000},
        {8.59840012, 7.35615301}},

        {{6.69626856, 7.25886059},
        {6.52549410, 7.36144972}},

        {{7.71711254, 7.79385471},
        {7.57863665, 8.35054302}},

        {{4.88373852, 6.39871025},
        {6.30057812, 5.32863426}}},


      {{{6.96206522, 8.43159199},
        {6.83061934, 7.42829943}},

        {{7.35133839, 8.24567509},
        {6.70658684, 9.45665741}},

        {{7.29201412, 6.47322607},
        {5.90080023, 7.87053108}},

        {{7.74224997, 8.80599689},
        {7.81940365, 9.29077721}},

        {{5.80813217, 5.95706034},
        {4.77996397, 6.56961155}}} });

    convInputUnrolledPad0Stride1.resize(27, 8);
    convInputUnrolledPad0Stride1.setValues({ {0.04538226, 0.61419797, 0.95949411, 0.84584051, 0.74790466, 0.38709599,
         0.73222357, 0.25413889},
        {0.95949411, 0.84584051, 0.50452268, 0.52509171, 0.73222357, 0.25413889,
         0.07335120, 0.74516875},
        {0.50452268, 0.52509171, 0.59602135, 0.18094194, 0.07335120, 0.74516875,
         0.85607505, 0.27006137},
        {0.74790466, 0.38709599, 0.73222357, 0.25413889, 0.90876633, 0.72085720,
         0.47080678, 0.84589291},
        {0.73222357, 0.25413889, 0.07335120, 0.74516875, 0.47080678, 0.84589291,
         0.24576986, 0.62312174},
        {0.07335120, 0.74516875, 0.85607505, 0.27006137, 0.24576986, 0.62312174,
         0.59051216, 0.93618810},
        {0.90876633, 0.72085720, 0.47080678, 0.84589291, 0.29745585, 0.64560336,
         0.98773926, 0.61316019},
        {0.47080678, 0.84589291, 0.24576986, 0.62312174, 0.98773926, 0.61316019,
         0.62964255, 0.96158671},
        {0.24576986, 0.62312174, 0.59051216, 0.93618810, 0.62964255, 0.96158671,
         0.36631453, 0.92482752},
        {0.50406832, 0.11359078, 0.42415136, 0.84837216, 0.46068907, 0.36437154,
         0.96129739, 0.10838908},
        {0.42415136, 0.84837216, 0.34337270, 0.81256318, 0.96129739, 0.10838908,
         0.62765759, 0.87681556},
        {0.34337270, 0.81256318, 0.72482306, 0.98481309, 0.62765759, 0.87681556,
         0.27029365, 0.37505645},
        {0.46068907, 0.36437154, 0.96129739, 0.10838908, 0.35458261, 0.05423701,
         0.38653296, 0.66477776},
        {0.96129739, 0.10838908, 0.62765759, 0.87681556, 0.38653296, 0.66477776,
         0.47089547, 0.46080470},
        {0.62765759, 0.87681556, 0.27029365, 0.37505645, 0.47089547, 0.46080470,
         0.82289129, 0.09901488},
        {0.35458261, 0.05423701, 0.38653296, 0.66477776, 0.63725311, 0.24049366,
         0.29671627, 0.78823119},
        {0.38653296, 0.66477776, 0.47089547, 0.46080470, 0.29671627, 0.78823119,
         0.54370487, 0.09643930},
        {0.47089547, 0.46080470, 0.82289129, 0.09901488, 0.54370487, 0.09643930,
         0.87211448, 0.77357787},
        {0.85018283, 0.92674822, 0.75999165, 0.49461865, 0.74964321, 0.43091267,
         0.10842186, 0.64998370},
        {0.75999165, 0.49461865, 0.15591985, 0.82311010, 0.10842186, 0.64998370,
         0.55331987, 0.53645664},
        {0.15591985, 0.82311010, 0.40320259, 0.50724411, 0.55331987, 0.53645664,
         0.58271384, 0.69436163},
        {0.74964321, 0.43091267, 0.10842186, 0.64998370, 0.67342269, 0.01849866,
         0.74921608, 0.22924691},
        {0.10842186, 0.64998370, 0.55331987, 0.53645664, 0.74921608, 0.22924691,
         0.96604007, 0.96253598},
        {0.55331987, 0.53645664, 0.58271384, 0.69436163, 0.96604007, 0.96253598,
         0.26602185, 0.99673647},
        {0.67342269, 0.01849866, 0.74921608, 0.22924691, 0.53013945, 0.09387362,
         0.98281318, 0.86051500},
        {0.74921608, 0.22924691, 0.96604007, 0.96253598, 0.98281318, 0.86051500,
         0.43664277, 0.52929527},
        {0.96604007, 0.96253598, 0.26602185, 0.99673647, 0.43664277, 0.52929527,
         0.76730776, 0.41473496} });

    dinputDilated2Padded1.resize(dims);
    dweightsDilated2Padded1.resize(kernelDims);
    outputDilated2Padded1.resize(convOutDims);

    outputDilated2Padded1.setValues({ {{{4.04924726, 3.78312683},
          {3.70934463, 3.27027488}},

         {{4.16936111, 3.31793475},
          {3.53340793, 3.56649876}},

         {{3.51772451, 2.21984434},
          {4.72297525, 2.89722109}},

         {{4.27168894, 2.43591619},
          {4.22755194, 2.61902285}},

         {{2.77083945, 2.38116765},
          {3.49386644, 2.90138841}}},


        {{{3.27508640, 3.27201819},
          {3.77221441, 3.88539004}},

         {{2.95074964, 2.88807154},
          {4.27476788, 4.63010454}},

         {{3.12232995, 1.83222532},
          {4.45044851, 3.54496050}},

         {{3.44286299, 2.59999180},
          {5.15567255, 3.02904558}},

         {{2.57737112, 2.08717346},
          {3.63113856, 3.86640406}}} });

    dinputDilated2Padded1.setValues({ {{{1.46331465, 2.75614643, 2.22961950, 1.44320130},
          {1.14025402, 1.66408229, 1.59960663, 2.06030178},
          {1.57871211, 2.23288250, 2.13630986, 2.69733810},
          {0.49294433, 0.49412695, 0.56188339, 1.01267684}},

         {{1.15349948, 2.27094555, 1.82776761, 1.52594686},
          {1.03503668, 1.43380189, 1.35803211, 1.30248439},
          {1.46192098, 1.85422623, 1.66414869, 1.33757007},
          {0.96598166, 1.40443826, 1.29567504, 1.79505515}},

         {{1.78323841, 2.39624023, 2.18691993, 1.71729577},
          {0.98204136, 1.59739745, 1.16975391, 0.93259817},
          {0.96970272, 1.95530200, 1.61224067, 1.11813641},
          {1.73503470, 1.29866993, 1.39277720, 1.01763713}}},


        {{{0.92261696, 2.20322537, 1.38130593, 1.57665467},
          {1.07163906, 1.32071936, 1.24600863, 1.86301172},
          {1.03104615, 1.63004351, 1.63177669, 1.87924814},
          {0.50755131, 0.41716534, 0.40007550, 0.83933073}},

         {{1.10189772, 2.23415208, 1.23475432, 1.14257669},
          {1.10579276, 1.13886595, 1.04560280, 0.56364655},
          {1.13099849, 1.60117233, 1.24992108, 1.40490437},
          {0.87599742, 1.01858485, 0.82680267, 1.68987787}},

         {{1.17720985, 1.67821741, 1.62238622, 1.05675685},
          {0.47843120, 1.36217093, 1.15730691, 0.37542766},
          {0.71687633, 1.87904203, 1.11094856, 0.63572407},
          {1.44721091, 1.50046873, 0.97536027, 0.57855284}}} });

    dweightsDilated2Padded1.setValues({ {{{0.33423513, 1.87676394, 0.50016510},
          {1.61623287, 2.11717510, 1.69692349},
          {0.37750378, 1.32587945, 0.30264884}},

         {{0.33788481, 1.63905823, 1.33425999},
          {0.70574272, 2.57452297, 0.73422945},
          {0.62231183, 0.76300240, 0.55103153}},

         {{0.93969774, 1.38917625, 0.70369047},
          {1.14058971, 2.38069487, 1.48203349},
          {0.50038236, 1.10551858, 0.45325553}}},


        {{{0.26602226, 1.68095851, 0.58789533},
          {1.30637467, 1.95159721, 1.36714792},
          {0.36214334, 1.52265465, 0.99141592}},

         {{0.42576659, 1.18448877, 0.92635703},
          {0.55955112, 2.07254076, 1.21851242},
          {0.25237095, 1.00457191, 1.04520774}},

         {{0.99526250, 1.25133896, 0.50409186},
          {0.88326359, 2.84540057, 1.37741125},
          {0.16129905, 1.50743103, 0.67477572}}},


        {{{0.37946063, 2.29258108, 0.65903556},
          {1.49845147, 2.89000344, 2.28174376},
          {0.34101558, 1.80081022, 0.84199977}},

         {{0.51090980, 1.86284208, 1.48152161},
          {0.58290559, 3.05391026, 1.23261499},
          {0.20832726, 0.83099461, 1.24035060}},

         {{1.26761651, 1.66810095, 0.78804684},
          {0.92170644, 3.00160885, 2.03240490},
          {0.12477185, 1.70111680, 0.94901633}}},


        {{{0.49714917, 1.31916559, 0.34640825},
          {1.78805494, 1.76254106, 0.81670862},
          {0.51939642, 1.38491297, 0.19274311}},

         {{0.41982806, 1.12851739, 0.46044779},
          {0.73718011, 2.23511887, 0.61020577},
          {0.49595523, 0.52089489, 0.44701147}},

         {{1.26722765, 1.18438482, 0.25405744},
          {1.12284827, 2.47428513, 0.50168943},
          {0.35526809, 1.04024315, 0.39108244}}},


        {{{0.07204077, 1.64589763, 0.61482936},
          {0.88264692, 2.10962009, 1.79861796},
          {0.45966375, 1.68695283, 0.93213272}},

         {{0.16540846, 1.20584011, 1.37053978},
          {0.50702095, 2.23708820, 1.15294945},
          {0.41154966, 1.08481383, 1.00686574}},

         {{0.34854704, 1.12462211, 0.72934681},
          {0.76675445, 2.27878284, 1.84381366},
          {0.28909871, 1.58996964, 0.66017818}}} });
    }

    // 4d testa
    const array<Index, 4> dims = { 2, 3, 4, 4 }, poolDims = { 2, 3, 2, 2 }, kernelDims = { 5, 3, 3, 3 }, convOutDims = { 2, 5, 2, 2 };
    DeviceTensor<Device_, float, 4> convInput, convLoss, batchNormLoss, convWeights, dweight, dinput, output, dinputDilated2Padded1, dweightsDilated2Padded1, outputDilated2Padded1;
    DeviceTensor<Device_, float, 2> convInputUnrolledPad0Stride1;
  };
}